{% extends 'base.html' %}

{% block content %}
<div class="full-width-container">
    <div class="form-background">
        <p class="free-event-text">Your First Event is Free on us! ðŸŽ‰ </p>
        <h2>Create an Account</h2>
        <!-- Display Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Registration Form -->
        <form action="{{ url_for('auth.register') }}" method="POST" class="form-style" id="register-form" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            
            {% macro render_field(field, placeholder, type='text', is_required=True) %}
            <div class="form-group">
                {{ field.label }}
                {% if is_required %}<span class="required-star">*</span>{% endif %}

                {{ field(class="input-field", placeholder=placeholder, type=type) }}

                {% if field.errors %}
                    <div class="error-message">{{ field.errors[0] }}</div>
                {% endif %}
            </div>
            {% endmacro %}

            {{ render_field(form.first_name, 'Your legal first name') }}
            {{ render_field(form.last_name, 'Your legal last name') }}

            <div class="form-group">
                <label>Profile Image</label><br>
                
                <img src="{{ url_for('static', filename='profile_images/default.png') }}" 
                     id="profileImagePreview" alt="Profile Image Preview" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; object-fit: cover;">

                <input type="file" id="imageUploadInput" class="form-control" accept="image/*">

                <div id="cropperContainer" style="display:none; margin-top: 15px;">
                    <p>Crop your image:</p>
                    <div>
                        <img id="imageToCrop" style="max-width: 100%;">
                    </div>
                    <button type="button" id="cropButton" class="btn btn-primary" style="margin-top: 10px;">Crop Image</button>
                </div>

                <input type="hidden" id="croppedImageData" name="cropped_image_data">
            </div>

            {{ render_field(form.dob, '', type='date') }}
            {{ render_field(form.email, 'Required for communication', type='email') }}
            {{ render_field(form.address, 'e.g., 123 Main St, Portland, OR 97201') }}
            {{ render_field(form.emergency_contact_name, 'Name of your emergency contact') }}
            {{ render_field(form.emergency_contact_phone, 'Phone of your emergency contact', type='tel') }}

            <div class="form-group">
                {{ form.password.label }}<span class="required-star">*</span>
                <div class="password-wrapper">
                    {{ form.password(class="input-field", id="password", placeholder="") }}
                    <i class="bi bi-eye-slash toggle-password"></i>
                </div>
                <div id="password-strength">
                    <small class="strength-check" id="length">8+ chars</small>
                    <small class="strength-check" id="upper">1 uppercase</small>
                    <small class="strength-check" id="lower">1 lowercase</small>
                    <small class="strength-check" id="num">1 number</small>
                    <small class="strength-check" id="spec">1 symbol</small>
                </div>
                {% if form.password.errors %}
                    <div class="error-message">{{ form.password.errors[0] }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.confirm_password.label }}<span class="required-star">*</span>
                <div class="password-wrapper">
                    {{ form.confirm_password(class="input-field", id="confirm_password") }}
                    <i class="bi bi-eye-slash toggle-password"></i>
                </div>

                {% if not form.confirm_password.errors %}
                    <div id="password-match-success" class="success-message" style="display: none;">âœ… Password is strong and passwords match!</div>
                    <div id="password-mismatch-error" class="error-message" style="display: none;">Passwords must match.</div>
                    <div id="password-weak-error" class="error-message" style="display: none;">Password does not meet all requirements.</div>
                {% endif %}
                
                {% if form.confirm_password.errors %}
                    <div class="error-message">{{ form.confirm_password.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="form-group waiver-group">
                <label>
                    {{ form.waiver_agree(id="waiver_agree_checkbox") }}
                    <span>I agree to the 
                        <a href="{{ url_for('static', filename='waiver.pdf') }}" id="waiver-link" target="_blank">Waiver and Release of Liability</a>
                    </span>
                    <span class="required-star">*</span>
                </label>
                <div id="waiver-view-error" class="error-message" style="display: block;">
                    You must view the waiver before you can agree.
                </div>
                {% if form.waiver_agree.errors %}
                    <div class="error-message">{{ form.waiver_agree.errors[0] }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="signature-pad">Digital Signature:<span class="required-star">*</span></label>
                <div class="signature-pad-container"><canvas id="signature-pad" class="signature-pad"></canvas></div>
                <button type="button" id="clear-signature" class="btn btn-secondary">Clear</button>
                <input type="hidden" id="signature_data" name="signature_data">
            </div>

            <button type="submit" class="submit-btn" id="register-submit">Create Account</button>
            <div id="spinner" class="spinner" style="display: none;"></div>
        </form>
    </div>
</div>

<div id="welcome-popup" class="popup-container" style="display: none;">
    <div class="popup-content">
        <button class="close-btn" onclick="closePopup()">X</button>
        <p>
            <span>Hi, {{ first_name }}!</span>
            <span>Welcome to Pickup Volleyball.</span>
            <span>Explore volleyball events <a href="{{ url_for('main.events') }}">here</a>.</span>
        </p>
    </div>
</div>


<style>
    .required-star { color: red; margin-left: 3px; }
    .error-message { color: red; font-size: 0.8em; margin-top: 5px; }
    .strength-check { color: grey; margin-right: 10px; }
    .strength-check.valid { color: green; text-decoration: line-through; }
</style>

<script>
    // This function can be defined here
    function closePopup() {
        const popup = document.getElementById("welcome-popup");
        popup.style.display = "none";
        setTimeout(() => {
            window.location.href = "{{ url_for('main.home') }}";
        }, 100);
    }

    // A single listener for when the page is ready
    document.addEventListener("DOMContentLoaded", function () {
        // --- : Image Cropping Logic ---
        const imageUploadInput = document.getElementById('imageUploadInput');
        const cropperContainer = document.getElementById('cropperContainer');
        const imageToCrop = document.getElementById('imageToCrop');
        const cropButton = document.getElementById('cropButton');
        const hiddenInput = document.getElementById('croppedImageData');
        const previewImage = document.getElementById('profileImagePreview'); // Now this will be found correctly
        let cropper;

        if (imageUploadInput) { // Check if the element exists before adding listeners
            imageUploadInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        imageToCrop.src = reader.result;
                        cropperContainer.style.display = 'block';
                        if (cropper) cropper.destroy();
                        
                        cropper = new Cropper(imageToCrop, {
                            aspectRatio: 1,
                            viewMode: 1,
                            background: false,
                            autoCropArea: 0.8,
                        });
                    };
                    reader.readAsDataURL(files[0]);
                }
            });
        }

        if (cropButton) {
            cropButton.addEventListener('click', () => {
                if (!cropper) return;
                
                const canvas = cropper.getCroppedCanvas({
                    width: 256,
                    height: 256,
                    imageSmoothingQuality: 'high',
                });

                const croppedDataURL = canvas.toDataURL('image/png');
                hiddenInput.value = croppedDataURL;

                if (previewImage) {
                    previewImage.src = croppedDataURL;
                }
                
                cropperContainer.innerHTML = '<p style="color: green; font-weight: bold;">Image has been cropped.</p>';
            });
        }

           // --- Define all elements once at the top ---
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        const strengthChecks = {
            length: document.getElementById('length'),
            upper: document.getElementById('upper'),
            lower: document.getElementById('lower'),
            num: document.getElementById('num'),
            spec: document.getElementById('spec')
        };

        // --- Helper function to check password strength ---
        function isPasswordStrong(password) {
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSymbol = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            const isLongEnough = password.length >= 8;
            return hasUpperCase && hasLowerCase && hasNumber && hasSymbol && isLongEnough;
        }

        // --- Logic for the strength requirement checklist ---
        // This now calls our helper function instead of repeating logic.
        passwordInput.addEventListener('input', function() {
            const pass = passwordInput.value;
            strengthChecks.length.classList.toggle('valid', pass.length >= 8);
            strengthChecks.upper.classList.toggle('valid', /[A-Z]/.test(pass));
            strengthChecks.lower.classList.toggle('valid', /[a-z]/.test(pass));
            strengthChecks.num.classList.toggle('valid', /\d/.test(pass));
            strengthChecks.spec.classList.toggle('valid', /[!@#$%^&*(),.?":{}|<>]/.test(pass));
        });

        // --- Main function for password match and strength feedback ---
        function checkPasswordMatch() {
            const successMsg = document.getElementById('password-match-success');
            const mismatchMsg = document.getElementById('password-mismatch-error');
            const weakMsg = document.getElementById('password-weak-error');

            if (!successMsg || !mismatchMsg || !weakMsg) { return; }

            const pass1 = passwordInput.value;
            const pass2 = confirmPasswordInput.value;

            if (pass2 === '') {
                successMsg.style.display = 'none';
                mismatchMsg.style.display = 'none';
                weakMsg.style.display = 'none';
                return;
            }

            if (pass1 === pass2) {
                if (isPasswordStrong(pass1)) {
                    successMsg.style.display = 'block';
                    mismatchMsg.style.display = 'none';
                    weakMsg.style.display = 'none';
                } else {
                    successMsg.style.display = 'none';
                    mismatchMsg.style.display = 'none';
                    weakMsg.style.display = 'block';
                }
            } else {
                successMsg.style.display = 'none';
                mismatchMsg.style.display = 'block';
                weakMsg.style.display = 'none';
            }
        }
        
        // --- Attach event listeners ---
        // The checkPasswordMatch function runs when either password field is changed.
        passwordInput.addEventListener('input', checkPasswordMatch);
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);


        
        // --- Spinner, Popup, and Signature Pad Logic ---
        const registerForm = document.getElementById("register-form");
        const popup = document.getElementById("welcome-popup");
        const canvas = document.getElementById('signature-pad');
        
        // Spinner Logic
        if (registerForm) {
            registerForm.addEventListener("submit", function (e) {
                const submitButton = document.getElementById("register-submit");
                const spinner = document.getElementById("spinner");
                submitButton.disabled = true;
                spinner.style.display = "block";
            });
        }

        // Welcome Popup Logic
        const firstName = "{{ first_name|default('') }}";
        if (popup && firstName.trim()) {
            popup.style.display = "block";
            document.addEventListener("click", function (event) {
                if (!popup.contains(event.target) && popup.style.display === "block") {
                    closePopup();
                }
            });
        }

        // Signature Pad Logic
        if (canvas) {
            const signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)'
            });

            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear();
            }
            
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();

            const clearButton = document.getElementById('clear-signature');
            clearButton.addEventListener('click', function () {
                signaturePad.clear();
            });

            // This must be the same form as the spinner logic above
            const formForSignature = document.getElementById('register-form');
            formForSignature.addEventListener('submit', function (event) {
                if (signaturePad.isEmpty()) {
                    alert("Please provide a signature.");
                    event.preventDefault(); // Stop form submission
                    // Re-enable the submit button if validation fails
                    document.getElementById("register-submit").disabled = false;
                    document.getElementById("spinner").style.display = "none";
                } else {
                    const signatureDataInput = document.getElementById('signature_data');
                    signatureDataInput.value = signaturePad.toDataURL('image/png');
                }
            });
        }

        // In register.html, inside the <script> and DOMContentLoaded listener

        // --- Show Password Toggle Logic ---
        const togglePasswordIcons = document.querySelectorAll('.toggle-password');
        togglePasswordIcons.forEach(icon => {
            icon.addEventListener('click', function () {
                // Find the password input field right before the icon
                const passwordField = this.previousElementSibling;
                
                // Toggle the input type between "password" and "text"
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);
                
                // Toggle the icon's appearance between the eye and slashed-eye
                this.classList.toggle('bi-eye');
                this.classList.toggle('bi-eye-slash');
            });
        });
        
        const waiverLink = document.getElementById('waiver-link');
        const waiverCheckbox = document.getElementById('waiver_agree_checkbox');
        const waiverError = document.getElementById('waiver-view-error');

        // 1. Disable the checkbox when the page loads
        if (waiverCheckbox) {
            waiverCheckbox.disabled = true;
        }

        // 2. Add an event listener to the waiver link
        if (waiverLink && waiverCheckbox && waiverError) {
            waiverLink.addEventListener('click', function() {
                // 3. When the link is clicked, enable the checkbox and hide the error message
                waiverCheckbox.disabled = false;
                waiverError.style.display = 'none';
            });
        }

    });
</script>
{% endblock %}
