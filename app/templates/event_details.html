{% extends "base.html" %}

{% block title %}Event Details{% endblock %}

{% block content %}
<div class="event-details-container">
    <div class="event-info">
        <h1>{{ event.title }}</h1>

        {% if event_passed %}
            <div class="alert alert-secondary text-center" role="alert" style="margin-top: 20px;">
                <i class="bi bi-calendar-x"></i> <strong>This event has passed.</strong>
            </div>
        {% elif is_full %}
            <div id="full-msg" class="alert alert-warning text-center" role="alert" style="margin-top: 20px;">
                <i class="bi bi-info-circle"></i> This event is currently full. Check back later to see if a spot opens up!
            </div>
        {% endif %}

        {% if event.image_filename %}
            <img src="{{ url_for('static', filename='images/' + event.image_filename) }}" 
                    alt="Event Image"
                    class="event-image"
                    style="width: 100%; border-radius: 12px; margin-bottom: 1.5rem;">
        {% endif %}

        <h2>Details</h2>
        <p>
            <i class="bi bi-calendar-event"></i> <strong>Date:</strong> {{ event.formatted_date }}
        </p>
        <p>
            <i class="bi bi-clock"></i> <strong>Time:</strong> {{ event.start_time.strftime('%I:%M %p') }} - {{ event.end_time.strftime('%I:%M %p') }}
        </p>
        <p>
            <i class="bi bi-geo-alt"></i> <strong>Location:</strong> {{ event.location }}
        </p>

        {% if event.full_address %}
        <div class="address-section" style="margin-bottom: 20px;">
            <p style="margin-bottom: 10px;">
                <i class="bi bi-pin-map"></i> <strong>Address:</strong> {{ event.full_address }}
            </p>
            <a href="{{ maps_link }}" target="_blank" class="btn btn-secondary">
                <i class="bi bi-map"></i> Open in Google Maps
            </a>
        </div>
        {% endif %}

        <p><strong>Description:</strong></p>
        <div>{{ event.description | safe }}</div>

        {% if attendees %}
        <h2 style="margin-top: 2rem;">Who's Going ({{ event.rsvp_count or 0 }})</h2>
        <ul class="attendees-list">
        {% for person in attendees %}
            <li style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <img src="{{ url_for('static', filename='profile_images/' + (person.user.profile_image or 'default.png')) }}"
                        alt="User Image"
                        style="width: 40px; height: 40px; border-radius: 50%;">
                {% if person.user %}
                    {{ person.user.first_name }} {{ person.user.last_name }}
                {% else %}
                    {# If person.user is null, use the names stored on the EventAttendee object (the guest names) #}
                    {{ person.first_name }} {{ person.last_name }} (Guest Account)
                {% endif %}
                {% if person.guest_count > 0 %}
                    <span style="color: gray;">(+{{ person.guest_count }} guest{{ 's' if person.guest_count > 1 else '' }})</span>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
        {% endif %}

        <a href="{{ url_for('main.events') }}" class="btn-back-gray">Back to Events</a>
    </div>
</div>

<div class="sticky-action-bar">
    {% if event_passed %}
        <div style="width: 100%; text-align: center;">
            <button class="btn btn-secondary" style="width: 100%;" disabled>Event Closed (Passed)</button>
        </div>
    {% else %}
        <div class="price-info">
            <span class="price">${{ "%.2f"|format(event.ticket_price) }}</span>
            <span class="spots-left">{{ event.max_capacity - event.rsvp_count }} spots left</span>
        </div>
        <div class="action-buttons">
            {% if is_attending %}
                <button class="btn btn-primary edit-rsvp" 
                    data-event-id="{{ event.id }}" 
                    data-title="{{ event.title }}" 
                    data-ticket-price="{{ '%.2f' % event.ticket_price }}" 
                    data-guest-limit="{{ event.guest_limit if event.allow_guests else 0 }}" 
                    data-max-capacity="{{ event.max_capacity }}" 
                    data-rsvp-count="{{ event.rsvp_count }}">
                    Edit RSVP
                </button>
            {% elif event.status == 'canceled' %}
                <button class="btn btn-secondary" disabled>Canceled</button>
            {% elif event.rsvp_count >= event.max_capacity %}
                <button class="btn btn-secondary" disabled>Event Full</button>
            {% else %}
                <button class="btn btn-success custom-attend-button" 
                    data-event-id="{{ event.id }}" 
                    data-title="{{ event.title }}" 
                    data-time="{{ event.formatted_date }} {{ event.start_time.strftime('%I:%M %p') }}" 
                    data-ticket-price="{{ '%.2f' % event.ticket_price }}" 
                    data-location="{{event.location}}" 
                    data-guest-limit="{{ event.guest_limit if event.allow_guests else 0 }}" 
                    data-max-capacity="{{ event.max_capacity }}" 
                    data-rsvp-count="{{ event.rsvp_count }}">
                    Attend
                </button>
            {% endif %}
        </div>
    {% endif %}
</div>

<div id="rsvpModal" class="modal">
    <div class="modal-content">
        <div class="form-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="rsvpTitle" style="margin: 0;"></h2>
            <button type="button" id="closeRsvpX" class="close-button" aria-label="Close" style="font-size: 1.5rem; border: none; background: transparent; cursor: pointer;">&times;</button>
        </div>          
        <p id="rsvpEventInfo"></p>
        <p id="editGuestPrompt" style="margin: 4px 0 10px; font-weight: bold;"></p>
        <div class="guest-counter">
            <button type="button" id="guestDecrement">-</button>
            <span id="guestCount">0</span>
            <button type="button" id="guestIncrement">+</button>
        </div>

        <p id="capacityInfo" style="text-align: center; color: #555; font-style: italic; font-size: 0.9em; margin-top: 5px;"></p>

        <p>Total Price: <strong id="totalPrice">$<span id="totalPriceSpan">0.00</span></strong></p>
        
        <div id="updateGuestContainer" style="display: none; margin-top: 15px; text-align: center;">
             <button type="button" id="updateGuestsBtn" class="btn btn-green"> <i class="bi bi-person-plus"></i> Update Guests
             </button>
        </div>

        <div id="rsvp-action-container" style="margin-top: 15px; font-weight: bold; color: teal;"></div>
        <div id="paypal-container" style="margin-top: 15px;"></div>
        
        <div id="edit-rsvp-actions" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px; border-top: 1px solid #dee2e6; padding-top: 15px; display: none;">
            <div id="notGoingContainer" style="display: none;">
                <button type="button" id="notGoingBtn" class="btn btn-danger">
                    <i class="bi bi-x-circle"></i> Not Going
                </button>
            </div>
        </div>   
    </div>
</div>


<div id="guestCheckoutModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="form-header">
            <button type="button" class="close-button close-guest-modal">&times;</button>
        </div>
        <h2>Guest Checkout</h2>
        
        <form id="guestCheckoutForm">
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <label>Number of Guests (excluding you):</label>
                <div class="guest-counter">
                    <button type="button" id="guestGuestDecrement">-</button>
                    <span id="guestGuestCount">0</span>
                    <button type="button" id="guestGuestIncrement">+</button>
                </div>
                <p>Total to Pay: <strong id="guestTotalPrice">$0.00</strong></p>
            </div>

            <div class="form-row">
                <input type="text" id="guestFirstName" placeholder="First Name" required class="input-field" style="margin-bottom: 10px; width: 48%;">
                <input type="text" id="guestLastName" placeholder="Last Name" required class="input-field" style="margin-bottom: 10px; width: 48%;">
            </div>
            <input type="email" id="guestEmail" placeholder="Email Address (Must enter correctly to receive confirmation email)" required class="input-field" style="width: 100%; margin-bottom: 10px;">
            <input type="text" id="guestAddress" placeholder="Address (e.g. 123 Main St)" required class="input-field" style="width: 100%; margin-bottom: 10px;">
            <div class="form-group mb-3">
                <label for="guestDob" class="form-label">Date of Birth (Must be 18+) <span class="required-star">*</span></label>
                <input type="date" class="form-control" id="guestDob" name="guestDob" required>
                <div id="guestAgeError" class="error-message" style="color: red; display: none;"></div>
            </div>

            <input type="text" id="guestEmergName" placeholder="Emergency Contact Name" required class="input-field" style="width: 100%; margin-bottom: 10px;">
            <input type="tel" id="guestEmergPhone" placeholder="Emergency Contact Phone" required class="input-field" style="width: 100%; margin-bottom: 10px;">

            <div class="form-check" style="margin-top: 15px;">
                <input class="form-check-input" type="checkbox" id="guestWaiverCheckbox" required>
                
                <label class="form-check-label" for="guestWaiverCheckbox" style="color: #212529;">
                    I agree to the 
                    
                    <a href="/static/waiver.pdf" 
                    target="_blank" 
                    id="guestWaiverLink"
                    data-waiver-viewed="false"
                    style="color: #0d6efd; font-weight: 700; text-decoration: underline; cursor: pointer;">
                    Waiver and Release of Liability
                    </a>
                </label>
                
                <div id="waiverViewError" class="text-danger" style="font-size: 0.85em; display: none; margin-top: 3px;">
                    You must view the waiver by clicking the link before you can agree.
                </div>
            </div>

            <div class="form-group">
                <label>Digital Signature:</label>
                <div class="signature-pad-container" style="border: 1px solid #ccc;">
                    <canvas id="guestSignaturePad" class="signature-pad" style="width: 100%; height: 150px;"></canvas>
                </div>
                <button type="button" id="clearGuestSignature" class="btn btn-secondary btn-sm" style="margin-top: 5px;">Clear Signature</button>
            </div>

            <div id="guest-paypal-container" style="margin-top: 20px;"></div>
        </form>
    </div>
</div>
{% endblock %}


{% block page_scripts %}
    <script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD&intent=capture"
            onload="console.log('PayPal SDK loaded successfully')"
            onerror="console.error('Failed to load PayPal SDK')">
    </script>
    <script src="/static/js/events.js"></script>
{% endblock %}

{% block page_variables %}
        // These page-specific values will now override the defaults from base.html
        var isUserAuthenticated = {{ is_authenticated|tojson }};
        var userRole = {{ user_role|default('user')|tojson }};
        var userEventCredits = {{ user_event_credits|tojson }};
        var hasActiveSubscription = {{ has_active_subscription|tojson }}; 
        var currentEventData = {{ event_data|tojson|safe }};
{% endblock %}