{% extends "base.html" %}

{% block title %}Event Details{% endblock %}

{% block content %}
<div class="event-details-container">
    <div class="event-info">
        <h1>{{ event.title }}</h1>

        {% if event.image_filename %}
            <img src="{{ url_for('static', filename='images/' + event.image_filename) }}" 
                    alt="Event Image"
                    class="event-image"
                    style="width: 100%; border-radius: 12px; margin-bottom: 1.5rem;">
        {% endif %}

        <h2>Details</h2>
        <p>
            <i class="bi bi-calendar-event"></i> <strong>Date:</strong> {{ event.formatted_date }}
        </p>
        <p>
            <i class="bi bi-clock"></i> <strong>Time:</strong> {{ event.start_time.strftime('%I:%M %p') }} - {{ event.end_time.strftime('%I:%M %p') }}
        </p>
        <p>
            <i class="bi bi-geo-alt"></i> <strong>Location:</strong> {{ event.location }}
        </p>

        {% if event.full_address %}
        <div class="address-section" style="margin-bottom: 20px;">
            <p style="margin-bottom: 10px;">
                <i class="bi bi-pin-map"></i> <strong>Address:</strong> {{ event.full_address }}
            </p>
            <a href="{{ maps_link }}" target="_blank" class="btn btn-secondary">
                <i class="bi bi-map"></i> Open in Google Maps
            </a>
        </div>
        {% endif %}

        <p><strong>Description:</strong></p>
        <div>{{ event.description | safe }}</div>

        {% if attendees %}
        <h2 style="margin-top: 2rem;">Who's Going ({{ event.rsvp_count or 0 }})</h2>
        <ul class="attendees-list">
        {% for person in attendees %}
            <li style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <img src="{{ url_for('static', filename='profile_images/' + (person.user.profile_image or 'default.png')) }}"
                        alt="User Image"
                        style="width: 40px; height: 40px; border-radius: 50%;">
                {{ person.user.first_name }} {{ person.user.last_name }}
                {% if person.guest_count > 0 %}
                    <span style="color: gray;">(+{{ person.guest_count }} guest{{ 's' if person.guest_count > 1 else '' }})</span>
                {% endif %}
            </li>
        {% endfor %}
        </ul>
        {% endif %}

        <a href="{{ url_for('main.events') }}" class="btn-back-gray">Back to Events</a>    </div>
</div>

<div class="sticky-action-bar">
    <div class="price-info">
        <span class="price">${{ "%.2f"|format(event.ticket_price) }}</span>
        <span class="spots-left">{{ event.max_capacity - event.rsvp_count }} spots left</span>
    </div>
    <div class="action-buttons">            
        {% if event.status == 'canceled' %}
            <button class="btn btn-secondary" disabled>Canceled</button>
        {% elif event.rsvp_count >= event.max_capacity %}
            <button class="btn btn-secondary" disabled>Event Full</button>
        {% elif is_attending %}
            <button 
                class="btn btn-primary edit-rsvp"
                data-event-id="{{ event.id }}"
                data-title="{{ event.title }}"
                data-ticket-price="{{ '%.2f' % event.ticket_price }}"
                data-guest-limit="{{ event.guest_limit if event.allow_guests else 0 }}"
                data-max-capacity="{{ event.max_capacity }}"
                data-rsvp-count="{{ event.rsvp_count }}">
                Edit RSVP
            </button>
        {% else %}
            <button 
                class="btn btn-success custom-attend-button"
                data-event-id="{{ event.id }}"
                data-title="{{ event.title }}"
                data-time="{{ event.formatted_date }} {{ event.start_time.strftime('%I:%M %p') }}"
                data-ticket-price="{{ '%.2f' % event.ticket_price }}"
                data-location="{{event.location}}"
                data-guest-limit="{{ event.guest_limit if event.allow_guests else 0 }}"
                data-max-capacity="{{ event.max_capacity }}"
                data-rsvp-count="{{ event.rsvp_count }}">
                Attend
            </button>
        {% endif %}
    </div>
</div>

<div id="rsvpModal" class="modal">
    <div class="modal-content">
        <div class="form-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="rsvpTitle" style="margin: 0;"></h2>
            <button type="button" id="closeRsvpX" class="close-button" aria-label="Close" style="font-size: 1.5rem; border: none; background: transparent; cursor: pointer;">&times;</button>
        </div>          
        <p id="rsvpEventInfo"></p>
        <p id="editGuestPrompt" style="margin: 4px 0 10px; font-weight: bold;"></p>
        <div class="guest-counter">
        <button type="button" id="guestDecrement">-</button>
        <span id="guestCount">0</span>
        <button type="button" id="guestIncrement">+</button>
        </div>

        <p id="capacityInfo" style="text-align: center; color: #555; font-style: italic; font-size: 0.9em; margin-top: 5px;"></p>

        <p>Total Price: <strong id="totalPrice">$<span id="totalPriceSpan">0.00</span></strong></p>
        <div id="rsvp-action-container" style="margin-top: 15px; font-weight: bold; color: teal;"></div>
        <div id="paypal-container" style="margin-top: 15px;"></div>
        <button type="button" id="closeRsvpModal" class="btn btn-grey">Cancel</button>
    </div>
</div>
{% endblock %}


{% block page_variables %}
        // These page-specific values will now override the defaults from base.html
        var isUserAuthenticated = {{ is_authenticated|tojson }};
        var userRole = {{ user_role|default('user')|tojson }};
        var userHasFreeEvent = {{ user_has_free_event|tojson }};
        var userEventCredits = {{ user_event_credits|tojson }};
        var userSubscriptionExpiryDate = {{ user_subscription_expiry_date|tojson }};
        //var currentEventData = {{ event_data|tojson|safe }};
{% endblock %}